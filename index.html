<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Respuesta</title>
  
  <!-- Incluyendo Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 20%;
    }
    button {
      font-size: 16px;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>¿Me extrañas?</h1>
  <button id="btnYes" onclick="saveResponse('Sí')">Sí</button>
  <button id="btnNo" onclick="saveResponse('No')">No</button>
  
  <!-- Botón para enviar respuesta -->
  <button id="btnSubmit" onclick="submitResponse()" disabled>Enviar</button>
  
  <script>
    // Configuración de Firebase (Reemplaza estos valores con los de tu proyecto Firebase)
    const firebaseConfig = {
      apiKey: "AIzaSyCcC_CVxXfcbiHlq9x93yx6Lb4NBSlmvqg",
      authDomain: "geolo-43bb5.firebaseapp.com",
      databaseURL: "https://geolo-43bb5-default-rtdb.firebaseio.com",
      projectId: "geolo-43bb5",
      storageBucket: "geolo-43bb5.firebasestorage.app",
      messagingSenderId: "309213681934",
      appId: "1:309213681934:web:71f92b1abd221444b2df5f"
    };

    // Inicialización de Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let userResponse = ""; // Variable para guardar la respuesta ("Sí" o "No")
    let userLocation = { latitude: null, longitude: null }; // Variable para la ubicación

    // Función para guardar la respuesta y la ubicación
    function saveResponse(response) {
      userResponse = response;
      console.log("Respuesta guardada:", userResponse);

      // Obtener la ubicación del usuario
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation.latitude = position.coords.latitude;
            userLocation.longitude = position.coords.longitude;
            console.log("Ubicación obtenida:", userLocation);
            // Habilitar el botón de enviar solo después de obtener la ubicación
            document.getElementById('btnSubmit').disabled = false;
          },
          (error) => {
            alert("No se pudo obtener tu ubicación.");
            console.error(error);
          }
        );
      } else {
        alert("Tu navegador no soporta geolocalización.");
      }
    }

    // Función para enviar los datos a Firebase
    function submitResponse() {
      console.log("Intentando enviar respuesta...");
      if (userResponse && userLocation.latitude && userLocation.longitude) {
        console.log("Datos listos para enviar:", userResponse, userLocation);
        
        // Guardar la respuesta y la ubicación en la base de datos de Firebase
        const responseRef = database.ref('responses').push(); // Crea un nuevo nodo para la respuesta
        responseRef.set({
          answer: userResponse,
          latitude: userLocation.latitude,
          longitude: userLocation.longitude,
          timestamp: new Date().toISOString()
        }).then(() => {
          alert("Gracias por responder. ¡Tu respuesta ha sido registrada!");
          window.close(); // Cierra el formulario
        }).catch((error) => {
          alert("Hubo un error al enviar tu respuesta.");
          console.error("Error de Firebase:", error);
        });
      } else {
        alert("Por favor, selecciona una respuesta y espera a que se obtenga tu ubicación.");
        console.log("Datos incompletos:", userResponse, userLocation);
      }
    }
  </script>
</body>
</html>
